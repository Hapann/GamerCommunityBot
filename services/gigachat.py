# services/gigachat.py
import json
import requests
from logger.logger import logger

PROXY_HOST = "http://10.63.0.110:8000"

PROMPT_TEMPLATE = """
–¢—ã ‚Äî –æ–ø—ã—Ç–Ω—ã–π –∏–≥—Ä–æ–≤–æ–π –∂—É—Ä–Ω–∞–ª–∏—Å—Ç. –ù–∞ –≤—Ö–æ–¥ —Ç—ã –ø–æ–ª—É—á–∞–µ—à—å —Å—Å—ã–ª–∫—É –Ω–∞ —Å–∞–π—Ç –∏–ª–∏ —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—å–∏.
–¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ –º–∞—Ç–µ—Ä–∏–∞–ª—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫–æ—Ä–æ—Ç–∫—É—é –Ω–æ–≤–æ—Å—Ç–Ω—É—é –∑–∞–º–µ—Ç–∫—É –¥–ª—è –∏–≥—Ä–æ–≤–æ–≥–æ –ø–∞–±–ª–∏–∫–∞.

–ï—Å–ª–∏ –ø–æ —Å—Å—ã–ª–∫–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è
–∏–ª–∏ –¥–∞–Ω–Ω—ã–µ —Å–ª–∏—à–∫–æ–º —Å–∫—É–¥–Ω—ã–µ, –ø–æ—Å—Ç–∞—Ä–∞–π—Å—è –Ω–∞–π—Ç–∏ —Å–≤–µ–¥–µ–Ω–∏—è –æ–± —ç—Ç–æ–π –Ω–æ–≤–æ—Å—Ç–∏
–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ (–ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –¥–æ–º–µ–Ω–∞, —Ç–µ–º–µ –∏–ª–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—É –∞–¥—Ä–µ—Å–∞).
–ï—Å–ª–∏ –¥–∞–∂–µ –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∏—á–µ–≥–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã—è—Å–Ω–∏—Ç—å,
—Å–æ—Å—Ç–∞–≤—å –∫–æ—Ä–æ—Ç–∫–∏–π –ø–æ—Å—Ç-–∑–∞–≥–ª—É—à–∫—É –ø–æ —Ç–µ–º –∂–µ –ø—Ä–∞–≤–∏–ª–∞–º –∏ –¥–æ–±–∞–≤—å
—á–µ—Å—Ç–Ω—É—é –ø—Ä–∏–ø–∏—Å–∫—É, —á—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –Ω–∞–π—Ç–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å.

–§–æ—Ä–º–∞—Ç –∑–∞–≥–ª—É—à–∫–∏:

–°—Å—ã–ª–∫–∞: {url_or_text}
–ó–∞–≥–æ–ª–æ–≤–æ–∫: *(–∫–æ—Ä–æ—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –¥–æ–º–µ–Ω–µ –∏–ª–∏ –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–æ–π —Ç–µ–º–µ)*
–¢–µ–∫—Å—Ç: "–ú–Ω–µ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ,
–ø–æ—ç—Ç–æ–º—É –ø–æ–ª–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –í–æ–∑–º–æ–∂–Ω–æ, –∏—Å—Ç–æ—á–Ω–∏–∫ –±—ã–ª —É–¥–∞–ª—ë–Ω
–∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç."
–¢–µ–≥–∏: #–Ω–æ–≤–æ—Å—Ç—å #–∏–≥—Ä—ã #–∏—Å—Ç–æ—á–Ω–∏–∫–Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

---

–û–±—ã—á–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:

–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: {url_or_text}

–ó–∞–≥–æ–ª–æ–≤–æ–∫: –¥–æ 10 —Å–ª–æ–≤, –¥–∏–Ω–∞–º–∏—á–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π

–ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫: *(–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, 1 —Å—Ç—Ä–æ–∫–∞ —É—Ç–æ—á–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)*

–¢–µ–∫—Å—Ç: "5‚Äì10 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å –∫—Ä–∞—Ç–∫–∏–º –∏ –∂–∏–≤—ã–º –ø–µ—Ä–µ—Å–∫–∞–∑–æ–º —Å—É—Ç–∏ –Ω–æ–≤–æ—Å—Ç–∏.
–ù–∞–ø–∏—à–∏ –ø–æ–Ω—è—Ç–Ω–æ, —Å –ª—ë–≥–∫–æ–π —ç–º–æ—Ü–∏–µ–π, –Ω–æ –±–µ–∑ –∫–ª–∏–∫–±–µ–π—Ç–∞.
–£–∫–∞–∂–∏ –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã: —á—Ç–æ —Å–ª—É—á–∏–ª–æ—Å—å, –∫—Ç–æ —É—á–∞—Å—Ç–Ω–∏–∫–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –≤–∞–∂–Ω–æ, –∏ —Ä–µ–∞–∫—Ü–∏—é —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ –∏–ª–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è.
–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Å–ª—É–∂–µ–±–Ω—ã–µ —Å–ª–æ–≤–∞ –≤—Ä–æ–¥–µ '–∞–Ω–∞–ª–∏–∑', '—Å—Ç—Ä—É–∫—Ç—É—Ä–∞', '–≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'."

–¢–µ–≥–∏:
#–Ω–∞–∑–≤–∞–Ω–∏–µ–∏–≥—Ä—ã #–∂–∞–Ω—Ä #–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ #–Ω–æ–≤–æ—Å—Ç–∏ #–Ω–∞–∑–≤–∞–Ω–∏–µ—Å—Ç—É–¥–∏–∏

–¢–æ–Ω:
‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –∂–∏–≤–æ–π, –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞;
‚Äî –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª—ë–≥–∫–∞—è –∏—Ä–æ–Ω–∏—è, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–∞;
‚Äî –∏–∑–±–µ–≥–∞–π —Å–ª–æ–∂–Ω—ã—Ö –æ–±–æ—Ä–æ—Ç–æ–≤ –∏ –≥—Ä–æ–º–æ–∑–¥–∫–∏—Ö –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–π.

–ü—Ä–∏–º–µ—Ä—ã:

---

–ü—Ä–∏–º–µ—Ä 1
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: https://bethesda.net/ru/article/starfield-mod-tools-release

–ó–∞–≥–æ–ª–æ–≤–æ–∫: Starfield –Ω–∞–∫–æ–Ω–µ—Ü –ø–æ–ª—É—á–∏–ª –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—É—é –ø–æ–¥–¥–µ—Ä–∂–∫—É –º–æ–¥–æ–≤!
–¢–µ–∫—Å—Ç: Bethesda –≤—ã–ø—É—Å—Ç–∏–ª–∞ –∫—Ä—É–ø–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è Starfield, –¥–æ–±–∞–≤–∏–≤ –¥–æ–ª–≥–æ–∂–¥–∞–Ω–Ω—ã–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞—Ä–∏–π Creation Kit. –¢–µ–ø–µ—Ä—å –∏–≥—Ä–æ–∫–∏ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ –¥–µ–ª–∏—Ç—å—Å—è –º–æ–¥–∞–º–∏, –Ω–µ –ø—Ä–∏–±–µ–≥–∞—è –∫ —Å—Ç–æ—Ä–æ–Ω–Ω–∏–º —Ö–∞–∫–∞–º. –ö–æ–º–∞–Ω–¥–∞ –æ–±–µ—â–∞–µ—Ç —Ä–µ–≥—É–ª—è—Ä–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ç–≤–æ—Ä—á–µ—Å–∫–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ, –∞ –ø–µ—Ä–≤—ã–µ —Ñ–∞–Ω–∞—Ç—Å–∫–∏–µ —Ç–≤–æ—Ä–µ–Ω–∏—è —É–∂–µ –ø–æ—è–≤–∏–ª–∏—Å—å –Ω–∞ Nexus Mods. –í —Ç–æ –∂–µ –≤—Ä–µ–º—è –º–æ–¥–¥–µ—Ä—ã –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—Ç: –ø–æ—Å–ª–µ –∞–ø–¥–µ–π—Ç–∞ —Å—Ç–∞—Ä—ã–µ –º–æ–¥—ã –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
–¢–µ–≥–∏: #Starfield #Bethesda #–º–æ–¥—ã #–Ω–æ–≤–æ—Å—Ç–∏ #RPG

---

–ü—Ä–∏–º–µ—Ä 2
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: https://store.steampowered.com/news/app/440/view/1234567890

–ó–∞–≥–æ–ª–æ–≤–æ–∫: Valve –≤–Ω–µ–∑–∞–ø–Ω–æ –æ–±–Ω–æ–≤–∏–ª–∞ Team Fortress 2
–¢–µ–∫—Å—Ç: –ü–æ—Å–ª–µ –¥–æ–ª–≥–æ–≥–æ –∑–∞—Ç–∏—à—å—è Valve –≤—ã–ø—É—Å—Ç–∏–ª–∞ –ø–∞—Ç—á –¥–ª—è Team Fortress 2, —É—Å—Ç—Ä–∞–Ω–∏–≤ –±–æ–ª–µ–µ —Å–æ—Ç–Ω–∏ –±–∞–≥–æ–≤ –∏ –¥–æ–±–∞–≤–∏–≤ –Ω–æ–≤—ã–π –∞–Ω—Ç–∏—á–∏—Ç. –ò–≥—Ä–æ–∫–∏ —à—É—Ç—è—Ç, —á—Ç–æ —ç—Ç–æ ¬´–∫–æ–Ω–µ—Ü —ç–ø–æ—Ö–∏ –º–µ–º–æ–≤ –ø—Ä–æ –∑–∞–±—ã—Ç—É—é TF2¬ª. –ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —Å–∫—Ä–æ–º–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∞–ø–¥–µ–π—Ç–∞, —Å–æ–æ–±—â–µ—Å—Ç–≤–æ –≤—Å—Ç—Ä–µ—Ç–∏–ª–æ –µ–≥–æ —Ç–µ–ø–ª–æ ‚Äî —Å–µ—Ä–≤–µ—Ä–∞ –æ–∂–∏–≤–∏–ª–∏—Å—å, –∞ –æ–Ω–ª–∞–π–Ω –≤ Steam –∑–∞–º–µ—Ç–Ω–æ –≤—ã—Ä–æ—Å.
–¢–µ–≥–∏: #TeamFortress2 #Valve #—à—É—Ç–µ—Ä—ã #–∞–ø–¥–µ–π—Ç #–Ω–æ–≤–æ—Å—Ç–∏

---

–ü—Ä–∏–º–µ—Ä 3
–°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫: https://larian.com/news/baldurs-goose-event

–ó–∞–≥–æ–ª–æ–≤–æ–∫: –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏ Baldur‚Äôs Gate 3 –¥–∞–ª–∏ –≥—É—Å—é –∑–≤–∞–Ω–∏–µ NPC –≥–æ–¥–∞
–¢–µ–∫—Å—Ç: Larian Studios –æ—Ç–º–µ—Ç–∏–ª–∞ —Å–º–µ—à–Ω—ã–º –ø–æ—Å—Ç–æ–º –ø–µ—Ä—Å–æ–Ω–∞–∂–∞-–≥—É—Å—ë–Ω–∫–∞ –∏–∑ Baldur‚Äôs Gate 3, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—á–∞–π–Ω–æ —Å—Ç–∞–ª –ª—é–±–∏–º—Ü–µ–º —Ñ–∞–Ω–∞—Ç–æ–≤. –í —á–µ—Å—Ç—å —ç—Ç–æ–≥–æ –≥–µ—Ä–æ—è —Ç–µ–ø–µ—Ä—å —É—Å—Ç—Ä–æ—è—Ç –º–∏–Ω–∏‚Äë–∏–≤–µ–Ω—Ç. –°–æ–æ–±—â–µ—Å—Ç–≤–æ –æ—Ü–µ–Ω–∏–ª–∞ —Å–∞–º–æ–∏—Ä–æ–Ω–∏—é —Å—Ç—É–¥–∏–∏ –∏ —É–∂–µ —Ä–∏—Å—É–µ—Ç —Ñ–∞–Ω-–∞—Ä—Ç—ã. –ì—É—Å–∏ —Å–Ω–æ–≤–∞ –∑–∞—Ö–≤–∞—Ç—ã–≤–∞—é—Ç RPG!
–¢–µ–≥–∏: #BaldursGate3 #Larian #RPG #—é–º–æ—Ä #–∏–≥—Ä—ã

---
"""


def get_gigachat_token():
    """–ü–æ–ª—É—á–∞–µ–º access_token —É –ø—Ä–æ–∫—Å–∏."""
    try:
        logger.debug("üîë –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω —É GigaChat-–ø—Ä–æ–∫—Å–∏...")
        resp = requests.post(f"{PROXY_HOST}/oauth/", timeout=5)
        resp.raise_for_status()
        token = resp.json().get("access_token")
        if not token:
            raise ValueError("–ü—Ä–æ–∫—Å–∏ –Ω–µ –≤–µ—Ä–Ω—É–ª access_token")
        logger.debug("‚úÖ –¢–æ–∫–µ–Ω —É—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω.")
        return token
    except Exception as e:
        logger.error(f"üí• –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: {e}")
        raise


def generate_gigachat_summary(url_or_text):
    """–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤ GigaChat –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ–π –Ω–æ–≤–æ—Å—Ç–∏ —Å –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º."""
    try:
        token = get_gigachat_token()
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json",
        }

        prompt = PROMPT_TEMPLATE.format(url_or_text=url_or_text)
        payload = {
            "model": "GigaChat",
            "messages": [{"role": "user", "content": prompt}],
            "stream": False,
            "repetition_penalty": 1,
        }

        # –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–π –ø—Ä–æ–º—Ç (–≤ —Ä–∞–∑—É–º–Ω—ã—Ö –ø—Ä–µ–¥–µ–ª–∞—Ö)
        trimmed_prompt = prompt[:600] + ("‚Ä¶" if len(prompt) > 600 else "")
        logger.debug(f"‚û°Ô∏è –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –≤ GigaChat –¥–ª—è URL: {url_or_text}\n---PROMPT START---\n{trimmed_prompt}\n---PROMPT END---")

        resp = requests.post(f"{PROXY_HOST}/chat/completions", headers=headers, json=payload, timeout=90)
        resp.raise_for_status()

        data = resp.json()
        reply = data["choices"][0]["message"]["content"]

        # –£—Ä–µ–∑–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ –ª–æ–≥–æ–≤
        trimmed_reply = reply[:600] + ("‚Ä¶" if len(reply) > 600 else "")
        logger.debug(f"‚¨ÖÔ∏è –û—Ç–≤–µ—Ç GigaChat –¥–ª—è URL: {url_or_text}\n---REPLY START---\n{trimmed_reply}\n---REPLY END---")

        logger.info(f"‚ú® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω –æ—Ç GigaChat ({len(reply)} —Å–∏–º–≤–æ–ª–æ–≤).")
        return reply

    except requests.Timeout:
        logger.error(f"‚è∞ –¢–∞–π–º–∞—É—Ç –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ GigaChat –¥–ª—è {url_or_text}")
        return f"‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä GigaChat –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª –≤–æ–≤—Ä–µ–º—è. –ò—Å—Ç–æ—á–Ω–∏–∫: {url_or_text}"
    except Exception as e:
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å –¥–µ—Ç–∞–ª—è–º–∏ JSON –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        try:
            debug_data = json.dumps(resp.json(), ensure_ascii=False, indent=2)[:1000]
            logger.debug(f"üì¶ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ: {debug_data}")
        except Exception:
            pass

        logger.error(f"üí• –û—à–∏–±–∫–∞ –≤–æ –≤—Ä–µ–º—è –æ–±—â–µ–Ω–∏—è —Å GigaChat –¥–ª—è {url_or_text}: {e}")
        return f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –Ω–æ–≤–æ—Å—Ç–∏\n{url_or_text}"
